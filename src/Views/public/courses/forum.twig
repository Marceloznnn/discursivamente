{% extends 'layouts/base.twig' %}

{% block title %}Fórum – {{ course.getTitle() }}{% endblock %}

{% block styles %}
  <link rel="stylesheet" href="/assets/css/pages/curso/aluno/forum.css">
{% endblock %}

{% block content %}
  <div class="forum-container">
    
    {# Breadcrumb / Navegação #}
    <nav class="breadcrumb" aria-label="Breadcrumb">
      <ol>
        <li><a href="/courses">Cursos</a></li>
        <li><a href="/courses/{{ course.getId() }}">{{ course.getTitle() }}</a></li>
        <li class="current">Fórum</li>
      </ol>
    </nav>

    {# Cabeçalho do Fórum #}
    <header class="forum-header">
      <h1>Fórum do Curso</h1>
      <p class="course-title">{{ course.getTitle() }}</p>
    </header>

    {# Container das Mensagens #}
    <div id="messages" class="messages-container">
      {% if messages is empty %}
        <p class="no-messages">Nenhuma mensagem ainda. Seja o primeiro a falar!</p>
      {% endif %}

      {% for message in messages %}
        {# Verifica se é mensagem do próprio usuário #}
        {% set isOwn = currentUser and currentUser.id == message.user_id %}
        <div class="
            message
            {{ isOwn ? 'sent' : 'received' }}
            {{ message.user_id == teacher.getId() ? 'teacher-message' : '' }}
          ">
          <div class="message-bubble">
            
            {# Cabeçalho da mensagem com avatar e informações do usuário #}
            <div class="message-header">
              <img
                src="{{ message.user_avatar|default('/assets/default-avatar.png') }}"
                alt="Avatar"
                class="avatar"
              >
              <div class="message-info">
                <strong>{{ isOwn ? 'Você' : message.user_name }}</strong>
                <time datetime="{{ message.created_at|date('c') }}">
                  {{ message.created_at|date('d/m/Y H:i') }}
                </time>
              </div>
            </div>

            {# Conteúdo da mensagem #}
            <div class="message-content">
              {{ message.message|nl2br }}
            </div>

          </div>
        </div>
      {% endfor %}
    </div>

    {# Formulário para envio de mensagens #}
    <form id="messageForm" class="message-form" data-course-id="{{ course.getId() }}">
      <textarea
        id="messageInput"
        name="message"
        placeholder="Digite sua mensagem..."
        required
      ></textarea>
      <button type="submit" class="btn-primary">
        <i class="fas fa-paper-plane"></i> Enviar
      </button>
    </form>

  </div>
{% endblock %}

{% block scripts %}
  <script>
    window.FORUM_CONFIG = {
      userId: {{ currentUser.id|default('null') }},
      courseId: {{ course.getId() }},
      wsUrl: 'ws://{{ app.request.host }}:8080' // WebSocket para chat em tempo real
    };
  </script>
  <script src="/assets/js/pages/curso/aluno/forum-chat.js" defer></script>
{% endblock %}
