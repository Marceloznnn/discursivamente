{% extends 'layouts/base.twig' %}

{% block styles %}
  <link rel="stylesheet" href="/assets/css/pages/curso/aluno/show.css">
{% endblock %}

{% block content %}
  <div class="course-page">

    <!-- Cabe√ßalho do Curso -->
    <section class="course-header">
      <h1 class="course-title">{{ course.title }}</h1>
      <p class="course-description">{{ course.description }}</p>
    </section>

    <!-- A√ß√µes de Participa√ß√£o e Progresso -->
    <section class="course-actions">
      <div class="action-buttons">
        {% if session.user %}
          {% if isParticipating %}
            <form action="/courses/{{ course.id }}/leave" method="post" class="action-form">
              <button type="submit" class="button-exit">
                Sair do curso
              </button>
            </form>
            <a href="/courses/{{ course.id }}/materials" class="button-materials">
              Ver Materiais ({{ materials|length }})
            </a>
          {% else %}
            <form action="/courses/{{ course.id }}/join" method="post" class="action-form">
              <button type="submit" class="button-join">
                Participar do curso
              </button>
            </form>
          {% endif %}
        {% else %}
          <button class="button-disabled" disabled>
            Fa√ßa login para participar
          </button>
        {% endif %}
      </div>

      {% if isParticipating %}
        <div class="progress-section">
          <label for="progress-bar">Progresso</label>
          <progress id="progress-bar" class="progress-bar" value="{{ progress }}" max="100">
            {{ progress }}%
          </progress>
        </div>
      {% endif %}
    </section>

    <!-- Materiais do Curso -->
    {% if isParticipating %}
      <section class="materials-section">
        <h2>Materiais do Curso</h2>
        <div class="materials-list">
          {% for m in materials %}
            <div class="material-item">
              <span class="material-icon">üìÑ</span>
              <div class="material-info">
                <h3>{{ m.title }}</h3>
                <p class="material-type">{{ m.type|default('Documento') }}</p>
              </div>
              {% if m.id in completedMaterials %}
                <span class="material-status">Conclu√≠do</span>
              {% endif %}
            </div>
          {% else %}
            <p class="no-materials">Nenhum material dispon√≠vel.</p>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    <!-- Coment√°rios -->
    <section class="comments-section">
      <h2 id="comments">Coment√°rios</h2>

      <div class="comments-list">
        {% for c in comments %}
          <div class="comment-item">
            <div class="comment-header">
              <div class="comment-author-info">
                <strong>{{ c.userName }}</strong>
                <time>{{ c.createdAt|date("d/m/Y H:i") }}</time>
              </div>
              {% if session.user and session.user.id == c.userId %}
                <form action="/courses/{{ course.id }}/comments/{{ c.id }}/delete" method="post" class="delete-form">
                  <button type="submit" class="delete-button" title="Excluir coment√°rio">
                    üóëÔ∏è
                  </button>
                </form>
              {% endif %}
            </div>
            <div class="comment-rating">
              {% for i in 1..5 %}
                {% if i <= c.rating %}
                  <span class="star filled">‚òÖ</span>
                {% else %}
                  <span class="star">‚òÜ</span>
                {% endif %}
              {% endfor %}
            </div>
            <p class="comment-text">{{ c.comment }}</p>
          </div>
        {% else %}
          <p class="no-comments">Seja o primeiro a comentar!</p>
        {% endfor %}
      </div>

      <div class="comment-form-section">
        {% if session.user %}
          <form action="/courses/{{ course.id }}/comment" method="post" class="comment-form">
            {% if session.flash.error %}
              <div class="form-errors">
                {% for msg in session.flash.error %}
                  <p>{{ msg }}</p>
                {% endfor %}
              </div>
            {% endif %}

            <div class="form-group">
              <label for="comment">Coment√°rio:</label>
              <textarea id="comment" name="comment" rows="4">{{ app.request.get('comment') }}</textarea>
            </div>

            <fieldset class="rating-input">
              <legend>Avalia√ß√£o:</legend>
              <div class="stars">
                {% for i in 5..1 %}
                  <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" />
                  <label for="star{{ i }}" class="star">‚òÖ</label>
                {% endfor %}
              </div>
            </fieldset>

            <button type="submit" class="submit-button">Enviar coment√°rio</button>

            {% if session.flash.success %}
              <div class="form-success">
                {% for msg in session.flash.success %}
                  <p>{{ msg }}</p>
                {% endfor %}
              </div>
            {% endif %}
          </form>
        {% else %}
          <p class="login-prompt">
            <a href="/login">Fa√ßa login para deixar um coment√°rio.</a>
          </p>
        {% endif %}
      </div>
    </section>

    <!-- Voltar -->
    <div class="back-link">
      <a href="/courses">‚Üê Voltar a todos os cursos</a>
    </div>

  </div>
{% endblock %}

{% block scripts %}
  <script>
    // Atualiza barra de progresso na p√°gina do curso
    window.updateCourseProgress = function() {
      fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newProgress = doc.querySelector('#progress-bar');
          if (newProgress) {
            document.getElementById('progress-bar').value = newProgress.value;
          }
        });
    };
  </script>
{% endblock %}